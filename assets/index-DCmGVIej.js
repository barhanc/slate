(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const c of document.querySelectorAll('link[rel="modulepreload"]'))a(c);new MutationObserver(c=>{for(const i of c)if(i.type==="childList")for(const l of i.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&a(l)}).observe(document,{childList:!0,subtree:!0});function o(c){const i={};return c.integrity&&(i.integrity=c.integrity),c.referrerPolicy&&(i.referrerPolicy=c.referrerPolicy),c.crossOrigin==="use-credentials"?i.credentials="include":c.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function a(c){if(c.ep)return;c.ep=!0;const i=o(c);fetch(c.href,i)}})();function J(t,n,o){const a=t.toCanvasElement({withoutTransform:!0,withoutShadow:!0}),i=a.getContext("2d").getImageData(0,0,a.width,a.height),{width:l,height:h,data:v}=i,u=new Uint8Array(l*h),r=[],F=10;for(let s=0;s<h;s++)for(let d=0;d<l;d++){const b=s*l+d;if(v[b*4+3]===0||u[b])continue;const y=[],O=[[d,s]];u[b]=1;let j=d,A=s,p=d,B=s,Y=0;for(;Y<O.length;){const[x,w]=O[Y++];y.push([x,w]),j=Math.min(j,x),A=Math.min(A,w),p=Math.max(p,x),B=Math.max(B,w);for(let I=-1;I<=1;I++)for(let R=-1;R<=1;R++){if(R===0&&I===0)continue;const f=x+R,L=w+I;if(f>=0&&f<l&&L>=0&&L<h){const k=L*l+f;v[k*4+3]>0&&!u[k]&&(u[k]=1,O.push([f,L]))}}}y.length>F&&r.push({pixels:y,minX:j,minY:A,maxX:p,maxY:B})}if(r.length<=1)return null;const q=[],T=t.getCenterPoint(),U=o.util.degreesToRadians(t.angle),H=Math.cos(U),W=Math.sin(U);return r.forEach(s=>{const d=s.maxX-s.minX+1,b=s.maxY-s.minY+1,y=document.createElement("canvas");y.width=d,y.height=b;const O=y.getContext("2d"),j=O.createImageData(d,b);s.pixels.forEach(([x,w])=>{const I=(w*l+x)*4,R=((w-s.minY)*d+(x-s.minX))*4;for(let f=0;f<4;f++)j.data[R+f]=v[I+f]}),O.putImageData(j,0,0);const A={x:s.minX+d/2-l/2,y:s.minY+b/2-h/2},p={x:A.x*t.scaleX,y:A.y*t.scaleY},B={x:p.x*H-p.y*W,y:p.x*W+p.y*H},Y=new o.Image(y,{left:T.x+B.x,top:T.y+B.y,angle:t.angle,scaleX:t.scaleX,scaleY:t.scaleY,originX:"center",originY:"center"});q.push(Y)}),q}const e=new fabric.Canvas("c",{backgroundColor:"#f0f0f0",selection:!0,preserveObjectStacking:!0});let D=!1,P=0,M=0;const K=50;let g=[],C=[],E=!1;document.getElementById("context-bar");function N(){e.setWidth(window.innerWidth),e.setHeight(window.innerHeight),e.renderAll()}window.addEventListener("resize",N);N();e.on("mouse:wheel",function(t){const n=t.e.deltaY;let o=e.getZoom();o*=.999**n,o>20&&(o=20),o<.1&&(o=.1),e.zoomToPoint({x:t.e.offsetX,y:t.e.offsetY},o),t.e.preventDefault(),t.e.stopPropagation()});e.on("mouse:down",function(t){const n=t.e;n.altKey===!0&&(D=!0,e.selection=!1,P=n.clientX,M=n.clientY)});e.on("mouse:move",function(t){if(D){const n=t.e,o=e.viewportTransform;o[4]+=n.clientX-P,o[5]+=n.clientY-M,e.requestRenderAll(),P=n.clientX,M=n.clientY}});e.on("mouse:up",function(t){D&&(e.setViewportTransform(e.viewportTransform),D=!1,e.defaultCursor="default",e.selection=!0)});function m(){const t=e.getActiveObject(),n=document.getElementById("context-bar"),o=[document.getElementById("ctx-eraser"),document.getElementById("ctx-split"),document.getElementById("ctx-merge")];if(!t){n.classList.remove("visible"),n.style.display="none";return}n.style.display="flex",o.forEach(r=>{r.style.opacity="0.3",r.style.pointerEvents="none",r.style.cursor="default"});const a=[document.getElementById("ctx-eraser"),document.getElementById("ctx-split")];if(t.type==="image"&&a.forEach(r=>{r.style.opacity="1",r.style.pointerEvents="auto",r.style.cursor="pointer"}),t.type==="activeSelection"&&t.getObjects("image").length>1){const r=document.getElementById("ctx-merge");r.style.opacity="1",r.style.pointerEvents="auto",r.style.cursor="pointer"}const c=t.getBoundingRect(),i=60,l=n.offsetHeight,h=n.offsetWidth;let v=c.top-l-i,u=c.left+c.width/2-h/2;v<10&&(v=c.top+c.height+i),u<10&&(u=10),u+h>window.innerWidth&&(u=window.innerWidth-h-10),n.style.top=`${v}px`,n.style.left=`${u}px`}e.on("selection:created",m);e.on("selection:updated",m);e.on("selection:cleared",m);e.on("object:moving",m);e.on("object:scaling",m);e.on("object:rotating",m);e.on("mouse:up",m);e.on("mouse:wheel",m);document.getElementById("ctx-eraser").onclick=()=>{const t=e.getActiveObject();!t||t.type!=="image"||(e.freeDrawingBrush=new fabric.EraserBrush(e),e.freeDrawingBrush.width=20,e.isDrawingMode=!0,e.getObjects().forEach(n=>{n.erasable=!1}),t.hoverCursor="crosshair",t.erasable=!0,e.discardActiveObject(),e.requestRenderAll())};e.on("erasing:end",m);e.on("erasing:end",function(t){if(t.targets&&t.targets.length>0){const n=t.targets[0];e.isDrawingMode=!1,e.defaultCursor="default",n.hoverCursor="move",e.setActiveObject(n),e.fire("object:modified"),e.requestRenderAll()}});document.getElementById("ctx-split").onclick=()=>{const t=e.getActiveObject();if(!t||t.type!=="image")return;const n=J(t,e,fabric);!n||n.length===0||(E=!0,e.remove(t),n.forEach(o=>e.add(o)),e.setActiveObject(new fabric.ActiveSelection(n,{canvas:e})),e.requestRenderAll(),E=!1,X())};document.getElementById("ctx-merge").onclick=()=>{const t=e.getActiveObject();if(!t||t.type!=="activeSelection")return;const n=t.getObjects("image");if(n.length<2)return;E=!0;const o=t.toDataURL({});fabric.Image.fromURL(o,a=>{a.set({left:t.left,top:t.top,originX:"left",originY:"top"}),e.remove(...n),e.add(a),e.setActiveObject(a),e.requestRenderAll(),E=!1,X()})};document.getElementById("ctx-delete").onclick=()=>{const t=e.getActiveObject();t&&(t.type==="activeSelection"?(t.forEachObject(n=>e.remove(n)),e.discardActiveObject()):e.remove(t),e.requestRenderAll())};document.getElementById("ctx-back").onclick=()=>{const t=e.getActiveObject();t&&(e.sendToBack(t),e.discardActiveObject(),e.requestRenderAll(),e.fire("object:modified"))};document.getElementById("ctx-copy").onclick=()=>{const t=e.getActiveObject();t&&t.clone(function(n){e.discardActiveObject(),n.set({left:n.left+20,top:n.top+20,evented:!0}),n.type==="activeSelection"?(n.canvas=e,n.forEachObject(function(o){e.add(o)}),n.setCoords()):e.add(n),e.setActiveObject(n),e.requestRenderAll()})};document.getElementById("ctx-flip-h").onclick=()=>{const t=e.getActiveObject();t&&(t.set("flipX",!t.flipX),e.requestRenderAll(),e.fire("object:modified"))};document.getElementById("ctx-download").onclick=()=>{const t=e.getActiveObject();if(t){const n=t.toDataURL({format:"png",multiplier:4}),o=document.createElement("a");o.download="image.png",o.href=n,document.body.appendChild(o),o.click(),document.body.removeChild(o)}};document.getElementById("imgLoader").addEventListener("change",function(t){const n=t.target.files[0];if(!n)return;const o=new FileReader;o.onload=function(a){fabric.Image.fromURL(a.target.result,function(c){c.width>800&&c.scaleToWidth(800);const i=e.getVpCenter();c.set({left:i.x,top:i.y,originX:"center",originY:"center"}),e.add(c),e.setActiveObject(c)})},o.readAsDataURL(n),t.target.value=""});document.getElementById("btn-undo").onclick=V;document.getElementById("btn-redo").onclick=_;document.getElementById("btn-clear").onclick=()=>{confirm("Clear entire canvas?")&&(e.clear(),e.setBackgroundColor("#f0f0f0",e.renderAll.bind(e)))};function X(){if(E)return;C.length>0&&(C=[],S());const t=JSON.stringify(e.toJSON());g.push(t),g.length>K&&g.shift(),S()}function z(t){E=!0,e.loadFromJSON(t,function(){e.renderAll(),E=!1})}function V(){if(g.length<=1)return;const t=g.pop();C.push(t);const n=g[g.length-1];z(n),S()}function _(){if(C.length===0)return;const t=C.pop();g.push(t),z(t),S()}function S(){document.getElementById("btn-undo").disabled=g.length<=1,document.getElementById("btn-redo").disabled=C.length===0}X();e.on("object:added",X);e.on("object:modified",X);e.on("object:removed",X);
