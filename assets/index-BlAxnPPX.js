(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const c of i)if(c.type==="childList")for(const r of c.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function o(i){const c={};return i.integrity&&(c.integrity=i.integrity),i.referrerPolicy&&(c.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?c.credentials="include":i.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function s(i){if(i.ep)return;i.ep=!0;const c=o(i);fetch(i.href,c)}})();function J(t,n,o){const s=t.toCanvasElement({withoutTransform:!0,withoutShadow:!0}),c=s.getContext("2d").getImageData(0,0,s.width,s.height),{width:r,height:d,data:v}=c,u=new Uint8Array(r*d),l=[],z=10;for(let a=0;a<d;a++)for(let f=0;f<r;f++){const b=a*r+f;if(v[b*4+3]===0||u[b])continue;const p=[],A=[[f,a]];u[b]=1;let O=f,j=a,y=f,B=a,L=0;for(;L<A.length;){const[x,w]=A[L++];p.push([x,w]),O=Math.min(O,x),j=Math.min(j,w),y=Math.max(y,x),B=Math.max(B,w);for(let I=-1;I<=1;I++)for(let R=-1;R<=1;R++){if(R===0&&I===0)continue;const g=x+R,Y=w+I;if(g>=0&&g<r&&Y>=0&&Y<d){const k=Y*r+g;v[k*4+3]>0&&!u[k]&&(u[k]=1,A.push([g,Y]))}}}p.length>z&&l.push({pixels:p,minX:O,minY:j,maxX:y,maxY:B})}if(l.length<=1)return null;const T=[],U=t.getCenterPoint(),q=o.util.degreesToRadians(t.angle),H=Math.cos(q),W=Math.sin(q);return l.forEach(a=>{const f=a.maxX-a.minX+1,b=a.maxY-a.minY+1,p=document.createElement("canvas");p.width=f,p.height=b;const A=p.getContext("2d"),O=A.createImageData(f,b);a.pixels.forEach(([x,w])=>{const I=(w*r+x)*4,R=((w-a.minY)*f+(x-a.minX))*4;for(let g=0;g<4;g++)O.data[R+g]=v[I+g]}),A.putImageData(O,0,0);const j={x:a.minX+f/2-r/2,y:a.minY+b/2-d/2},y={x:j.x*t.scaleX,y:j.y*t.scaleY},B={x:y.x*H-y.y*W,y:y.x*W+y.y*H},L=new o.Image(p,{left:U.x+B.x,top:U.y+B.y,angle:t.angle,scaleX:t.scaleX,scaleY:t.scaleY,originX:"center",originY:"center"});T.push(L)}),T}const e=new fabric.Canvas("c",{backgroundColor:"#f0f0f0",selection:!0,preserveObjectStacking:!0});let D=!1,P=0,M=0;const V=50;let m=[],C=[],E=!1;document.getElementById("context-bar");function N(){e.setWidth(window.innerWidth),e.setHeight(window.innerHeight),e.renderAll()}window.addEventListener("resize",N);window.addEventListener("paste",t=>{if(t.clipboardData){const n=t.clipboardData.items;if(!n)return;for(let o=0;o<n.length;o++)if(n[o].type.indexOf("image")!==-1){const s=n[o].getAsFile();if(!s)continue;const i=new FileReader;i.onload=function(c){fabric.Image.fromURL(c.target.result,function(r){r.width>800&&r.scaleToWidth(800);const d=e.getVpCenter();r.set({left:d.x,top:d.y,originX:"center",originY:"center"}),e.add(r),e.setActiveObject(r)})},i.readAsDataURL(s)}}});N();e.on("mouse:wheel",function(t){const n=t.e.deltaY;let o=e.getZoom();o*=.999**n,o>20&&(o=20),o<.1&&(o=.1),e.zoomToPoint({x:t.e.offsetX,y:t.e.offsetY},o),t.e.preventDefault(),t.e.stopPropagation()});e.on("mouse:down",function(t){const n=t.e;n.altKey===!0&&(D=!0,e.selection=!1,P=n.clientX,M=n.clientY)});e.on("mouse:move",function(t){if(D){const n=t.e,o=e.viewportTransform;o[4]+=n.clientX-P,o[5]+=n.clientY-M,e.requestRenderAll(),P=n.clientX,M=n.clientY}});e.on("mouse:up",function(t){D&&(e.setViewportTransform(e.viewportTransform),D=!1,e.defaultCursor="default",e.selection=!0)});function h(){const t=e.getActiveObject(),n=document.getElementById("context-bar"),o=[document.getElementById("ctx-eraser"),document.getElementById("ctx-split"),document.getElementById("ctx-merge")];if(!t){n.classList.remove("visible"),n.style.display="none";return}n.style.display="flex",o.forEach(l=>{l.style.opacity="0.3",l.style.pointerEvents="none",l.style.cursor="default"});const s=[document.getElementById("ctx-eraser"),document.getElementById("ctx-split")];if(t.type==="image"&&s.forEach(l=>{l.style.opacity="1",l.style.pointerEvents="auto",l.style.cursor="pointer"}),t.type==="activeSelection"&&t.getObjects("image").length>1){const l=document.getElementById("ctx-merge");l.style.opacity="1",l.style.pointerEvents="auto",l.style.cursor="pointer"}const i=t.getBoundingRect(),c=60,r=n.offsetHeight,d=n.offsetWidth;let v=i.top-r-c,u=i.left+i.width/2-d/2;v<10&&(v=i.top+i.height+c),u<10&&(u=10),u+d>window.innerWidth&&(u=window.innerWidth-d-10),n.style.top=`${v}px`,n.style.left=`${u}px`}e.on("selection:created",h);e.on("selection:updated",h);e.on("selection:cleared",h);e.on("object:moving",h);e.on("object:scaling",h);e.on("object:rotating",h);e.on("mouse:up",h);e.on("mouse:wheel",h);document.getElementById("ctx-eraser").onclick=()=>{const t=e.getActiveObject();!t||t.type!=="image"||(e.freeDrawingBrush=new fabric.EraserBrush(e),e.freeDrawingBrush.width=20,e.isDrawingMode=!0,e.getObjects().forEach(n=>{n.erasable=!1}),t.hoverCursor="crosshair",t.erasable=!0,e.discardActiveObject(),e.requestRenderAll())};e.on("erasing:end",h);e.on("erasing:end",function(t){if(t.targets&&t.targets.length>0){const n=t.targets[0];e.isDrawingMode=!1,e.defaultCursor="default",n.hoverCursor="move",e.setActiveObject(n),e.fire("object:modified"),e.requestRenderAll()}});document.getElementById("ctx-split").onclick=()=>{const t=e.getActiveObject();if(!t||t.type!=="image")return;const n=J(t,e,fabric);!n||n.length===0||(E=!0,e.remove(t),n.forEach(o=>e.add(o)),e.setActiveObject(new fabric.ActiveSelection(n,{canvas:e})),e.requestRenderAll(),E=!1,X())};document.getElementById("ctx-merge").onclick=()=>{const t=e.getActiveObject();if(!t||t.type!=="activeSelection")return;const n=t.getObjects("image");if(n.length<2)return;E=!0;const o=t.toDataURL({});fabric.Image.fromURL(o,s=>{s.set({left:t.left,top:t.top,originX:"left",originY:"top"}),e.remove(...n),e.add(s),e.setActiveObject(s),e.requestRenderAll(),E=!1,X()})};document.getElementById("ctx-delete").onclick=()=>{const t=e.getActiveObject();t&&(t.type==="activeSelection"?(t.forEachObject(n=>e.remove(n)),e.discardActiveObject()):e.remove(t),e.requestRenderAll())};document.getElementById("ctx-back").onclick=()=>{const t=e.getActiveObject();t&&(e.sendToBack(t),e.discardActiveObject(),e.requestRenderAll(),e.fire("object:modified"))};document.getElementById("ctx-copy").onclick=()=>{const t=e.getActiveObject();t&&t.clone(function(n){e.discardActiveObject(),n.set({left:n.left+20,top:n.top+20,evented:!0}),n.type==="activeSelection"?(n.canvas=e,n.forEachObject(function(o){e.add(o)}),n.setCoords()):e.add(n),e.setActiveObject(n),e.requestRenderAll()})};document.getElementById("ctx-flip-h").onclick=()=>{const t=e.getActiveObject();t&&(t.set("flipX",!t.flipX),e.requestRenderAll(),e.fire("object:modified"))};document.getElementById("ctx-download").onclick=()=>{const t=e.getActiveObject();if(t){const n=t.toDataURL({format:"png",multiplier:4}),o=document.createElement("a");o.download="image.png",o.href=n,document.body.appendChild(o),o.click(),document.body.removeChild(o)}};document.getElementById("imgLoader").addEventListener("change",function(t){const n=t.target.files[0];if(!n)return;const o=new FileReader;o.onload=function(s){fabric.Image.fromURL(s.target.result,function(i){i.width>800&&i.scaleToWidth(800);const c=e.getVpCenter();i.set({left:c.x,top:c.y,originX:"center",originY:"center"}),e.add(i),e.setActiveObject(i)})},o.readAsDataURL(n),t.target.value=""});document.getElementById("btn-undo").onclick=K;document.getElementById("btn-redo").onclick=_;document.getElementById("btn-clear").onclick=()=>{confirm("Clear entire canvas?")&&(e.clear(),e.setBackgroundColor("#f0f0f0",e.renderAll.bind(e)))};function X(){if(E)return;C.length>0&&(C=[],S());const t=JSON.stringify(e.toJSON());m.push(t),m.length>V&&m.shift(),S()}function F(t){E=!0,e.loadFromJSON(t,function(){e.renderAll(),E=!1})}function K(){if(m.length<=1)return;const t=m.pop();C.push(t);const n=m[m.length-1];F(n),S()}function _(){if(C.length===0)return;const t=C.pop();m.push(t),F(t),S()}function S(){document.getElementById("btn-undo").disabled=m.length<=1,document.getElementById("btn-redo").disabled=C.length===0}X();e.on("object:added",X);e.on("object:modified",X);e.on("object:removed",X);
