(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))r(o);new MutationObserver(o=>{for(const c of o)if(c.type==="childList")for(const a of c.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&r(a)}).observe(document,{childList:!0,subtree:!0});function i(o){const c={};return o.integrity&&(c.integrity=o.integrity),o.referrerPolicy&&(c.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?c.credentials="include":o.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function r(o){if(o.ep)return;o.ep=!0;const c=i(o);fetch(o.href,c)}})();const e=new fabric.Canvas("c",{backgroundColor:"#f0f0f0",selection:!0,preserveObjectStacking:!0});let L=!1,M=0,S=0;const z=50;let g=[],I=[],R=!1;document.getElementById("context-bar");function N(){e.setWidth(window.innerWidth),e.setHeight(window.innerHeight),e.renderAll()}window.addEventListener("resize",N);N();e.on("mouse:wheel",function(t){const n=t.e.deltaY;let i=e.getZoom();i*=.999**n,i>20&&(i=20),i<.1&&(i=.1),e.zoomToPoint({x:t.e.offsetX,y:t.e.offsetY},i),t.e.preventDefault(),t.e.stopPropagation()});e.on("mouse:down",function(t){const n=t.e;n.altKey===!0&&(L=!0,e.selection=!1,M=n.clientX,S=n.clientY)});e.on("mouse:move",function(t){if(L){const n=t.e,i=e.viewportTransform;i[4]+=n.clientX-M,i[5]+=n.clientY-S,e.requestRenderAll(),M=n.clientX,S=n.clientY}});e.on("mouse:up",function(t){L&&(e.setViewportTransform(e.viewportTransform),L=!1,e.defaultCursor="default",e.selection=!0)});function m(){const t=e.getActiveObject(),n=document.getElementById("context-bar"),i=[document.getElementById("ctx-eraser"),document.getElementById("ctx-split")];if(!t){n.classList.remove("visible"),n.style.display="none";return}n.style.display="flex",t.type==="image"?i.forEach(f=>{f.style.opacity="1",f.style.pointerEvents="auto",f.style.cursor="pointer"}):i.forEach(f=>{f.style.opacity="0.3",f.style.pointerEvents="none",f.style.cursor="default"});const r=t.getBoundingRect(),o=60,c=n.offsetHeight,a=n.offsetWidth;let h=r.top-c-o,d=r.left+r.width/2-a/2;h<10&&(h=r.top+r.height+o),d<10&&(d=10),d+a>window.innerWidth&&(d=window.innerWidth-a-10),n.style.top=`${h}px`,n.style.left=`${d}px`}e.on("selection:created",m);e.on("selection:updated",m);e.on("selection:cleared",m);e.on("object:moving",m);e.on("object:scaling",m);e.on("object:rotating",m);e.on("mouse:up",m);e.on("mouse:wheel",m);e.on("erasing:end",m);document.getElementById("ctx-eraser").onclick=()=>{const t=e.getActiveObject();!t||t.type!=="image"||(e.freeDrawingBrush=new fabric.EraserBrush(e),e.freeDrawingBrush.width=30,e.isDrawingMode=!0,e.getObjects().forEach(n=>{n.erasable=!1}),t.hoverCursor="crosshair",t.erasable=!0,e.discardActiveObject(),e.requestRenderAll())};e.on("erasing:end",function(t){if(t.targets&&t.targets.length>0){const n=t.targets[0];e.isDrawingMode=!1,e.defaultCursor="default",n.hoverCursor="move",e.setActiveObject(n),e.fire("object:modified"),e.requestRenderAll()}});document.getElementById("ctx-split").onclick=()=>{const t=e.getActiveObject();t&&t.type==="image"&&F(t)};document.getElementById("ctx-delete").onclick=()=>{const t=e.getActiveObject();t&&(t.type==="activeSelection"?(t.forEachObject(n=>e.remove(n)),e.discardActiveObject()):e.remove(t),e.requestRenderAll())};document.getElementById("ctx-back").onclick=()=>{const t=e.getActiveObject();t&&(e.sendToBack(t),e.discardActiveObject(),e.requestRenderAll(),e.fire("object:modified"))};document.getElementById("ctx-copy").onclick=()=>{const t=e.getActiveObject();t&&t.clone(function(n){e.discardActiveObject(),n.set({left:n.left+20,top:n.top+20,evented:!0}),n.type==="activeSelection"?(n.canvas=e,n.forEachObject(function(i){e.add(i)}),n.setCoords()):e.add(n),e.setActiveObject(n),e.requestRenderAll()})};document.getElementById("ctx-flip-h").onclick=()=>{const t=e.getActiveObject();t&&(t.set("flipX",!t.flipX),e.requestRenderAll(),e.fire("object:modified"))};document.getElementById("ctx-download").onclick=()=>{const t=e.getActiveObject();if(t){const n=t.toDataURL({format:"png",multiplier:4}),i=document.createElement("a");i.download="image.png",i.href=n,document.body.appendChild(i),i.click(),document.body.removeChild(i)}};function F(t){const n=t.toCanvasElement({withoutTransform:!0,withoutShadow:!0}),r=n.getContext("2d").getImageData(0,0,n.width,n.height),{width:o,height:c,data:a}=r,h=new Uint8Array(o*c),d=[],f=10;for(let s=0;s<c;s++)for(let l=0;l<o;l++){const v=s*o+l;if(a[v*4+3]===0||h[v])continue;const p=[],w=[[l,s]];h[v]=1;let E=l,A=s,y=l,j=s,X=0;for(;X<w.length;){const[b,x]=w[X++];p.push([b,x]),E=Math.min(E,b),A=Math.min(A,x),y=Math.max(y,b),j=Math.max(j,x);for(let O=-1;O<=1;O++)for(let B=-1;B<=1;B++){if(B===0&&O===0)continue;const u=b+B,Y=x+O;if(u>=0&&u<o&&Y>=0&&Y<c){const k=Y*o+u;a[k*4+3]>0&&!h[k]&&(h[k]=1,w.push([u,Y]))}}}p.length>f&&d.push({pixels:p,minX:E,minY:A,maxX:y,maxY:j})}if(d.length<=1)return;R=!0,e.remove(t);const P=[],q=t.getCenterPoint(),T=fabric.util.degreesToRadians(t.angle),H=Math.cos(T),W=Math.sin(T);d.forEach(s=>{const l=s.maxX-s.minX+1,v=s.maxY-s.minY+1,p=document.createElement("canvas");p.width=l,p.height=v;const w=p.getContext("2d"),E=w.createImageData(l,v);s.pixels.forEach(([b,x])=>{const O=(x*o+b)*4,B=((x-s.minY)*l+(b-s.minX))*4;for(let u=0;u<4;u++)E.data[B+u]=a[O+u]}),w.putImageData(E,0,0);const A={x:s.minX+l/2-o/2,y:s.minY+v/2-c/2},y={x:A.x*t.scaleX,y:A.y*t.scaleY},j={x:y.x*H-y.y*W,y:y.x*W+y.y*H},X=new fabric.Image(p,{left:q.x+j.x,top:q.y+j.y,angle:t.angle,scaleX:t.scaleX,scaleY:t.scaleY,originX:"center",originY:"center"});e.add(X),P.push(X)}),P.length>0&&e.setActiveObject(new fabric.ActiveSelection(P,{canvas:e})),e.requestRenderAll(),R=!1,C()}document.getElementById("imgLoader").addEventListener("change",function(t){const n=t.target.files[0];if(!n)return;const i=new FileReader;i.onload=function(r){fabric.Image.fromURL(r.target.result,function(o){o.width>800&&o.scaleToWidth(800);const c=e.getVpCenter();o.set({left:c.x,top:c.y,originX:"center",originY:"center"}),e.add(o),e.setActiveObject(o)})},i.readAsDataURL(n),t.target.value=""});document.getElementById("btn-undo").onclick=J;document.getElementById("btn-redo").onclick=K;document.getElementById("btn-clear").onclick=()=>{confirm("Clear entire canvas?")&&(e.clear(),e.setBackgroundColor("#f0f0f0",e.renderAll.bind(e)),C())};function C(){if(R)return;I.length>0&&(I=[],D());const t=JSON.stringify(e.toJSON());g.push(t),g.length>z&&g.shift(),D()}function U(t){R=!0,e.loadFromJSON(t,function(){e.renderAll(),R=!1})}function J(){if(g.length<=1)return;const t=g.pop();I.push(t);const n=g[g.length-1];U(n),D()}function K(){if(I.length===0)return;const t=I.pop();g.push(t),U(t),D()}function D(){document.getElementById("btn-undo").disabled=g.length<=1,document.getElementById("btn-redo").disabled=I.length===0}C();e.on("object:added",C);e.on("object:modified",C);e.on("object:removed",C);
